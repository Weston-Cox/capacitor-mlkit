{"version":3,"file":"web.js","sourceRoot":"","sources":["../../src/web.ts"],"names":[],"mappings":"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","sourcesContent":["import { CapacitorException, ExceptionCode, WebPlugin } from '@capacitor/core';\r\n\r\nimport type { DetectedBarcode } from './barcode-detector';\r\nimport { BarcodeValueType, LensFacing } from './definitions';\r\nimport type {\r\n  BarcodeFormat,\r\n  BarcodesScannedEvent,\r\n  BarcodeScannerPlugin,\r\n  GetMaxZoomRatioResult,\r\n  GetMinZoomRatioResult,\r\n  GetZoomRatioResult,\r\n  IsGoogleBarcodeScannerModuleAvailableResult,\r\n  IsSupportedResult,\r\n  PermissionStatus,\r\n  ReadBarcodesFromImageOptions,\r\n  ReadBarcodesFromImageResult,\r\n  ScanResult,\r\n  SetZoomRatioOptions,\r\n  StartScanOptions,\r\n  IsTorchEnabledResult,\r\n  IsTorchAvailableResult,\r\n} from './definitions';\r\n\r\ndeclare global {\r\n  // eslint-disable-next-line @typescript-eslint/consistent-type-imports\r\n  const BarcodeDetector: typeof import('./barcode-detector').BarcodeDetector;\r\n}\r\n\r\nexport class BarcodeScannerWeb\r\n  extends WebPlugin\r\n  implements BarcodeScannerPlugin\r\n{\r\n  private readonly _isSupported = 'BarcodeDetector' in window;\r\n  private readonly errorVideoElementMissing = 'videoElement must be provided.';\r\n  private readonly eventBarcodesScanned = 'barcodesScanned';\r\n\r\n  private intervalId: number | undefined;\r\n  private stream: MediaStream | undefined;\r\n  private videoElement: HTMLVideoElement | undefined;\r\n\r\n  async startScan(options?: StartScanOptions): Promise<void> {\r\n    if (!this._isSupported) {\r\n      throw this.createUnavailableException();\r\n    }\r\n    if (!options?.videoElement) {\r\n      throw new Error(this.errorVideoElementMissing);\r\n    }\r\n    this.videoElement = options.videoElement;\r\n    this.stream = await navigator.mediaDevices.getUserMedia({\r\n      video: {\r\n        facingMode: {\r\n          ideal:\r\n            options?.lensFacing === LensFacing.Front ? 'user' : 'environment',\r\n        },\r\n      },\r\n      audio: false,\r\n    });\r\n    options.videoElement.srcObject = this.stream;\r\n    await options.videoElement.play();\r\n    const barcodeDetector = new BarcodeDetector();\r\n    this.intervalId = window.setInterval(async () => {\r\n      if (!options.videoElement) {\r\n        return;\r\n      }\r\n      const barcodes = await barcodeDetector.detect(options.videoElement);\r\n      if (barcodes.length === 0) {\r\n        return;\r\n      } else {\r\n        this.handleScannedBarcodes(barcodes);\r\n      }\r\n    }, 500);\r\n  }\r\n\r\n  async stopScan(): Promise<void> {\r\n    if (!this._isSupported) {\r\n      throw this.createUnavailableException();\r\n    }\r\n    if (this.intervalId) {\r\n      clearInterval(this.intervalId);\r\n      this.intervalId = undefined;\r\n    }\r\n    if (this.stream) {\r\n      this.stream.getTracks().forEach(track => track.stop());\r\n      this.stream = undefined;\r\n    }\r\n    if (this.videoElement) {\r\n      this.videoElement.srcObject = null;\r\n      this.videoElement = undefined;\r\n    }\r\n  }\r\n\r\n  async readBarcodesFromImage(\r\n    _options: ReadBarcodesFromImageOptions,\r\n  ): Promise<ReadBarcodesFromImageResult> {\r\n    throw this.createUnavailableException();\r\n  }\r\n\r\n  async scan(): Promise<ScanResult> {\r\n    throw this.createUnavailableException();\r\n  }\r\n\r\n  async isSupported(): Promise<IsSupportedResult> {\r\n    return { supported: this._isSupported };\r\n  }\r\n\r\n  async enableTorch(): Promise<void> {\r\n    throw this.createUnavailableException();\r\n  }\r\n\r\n  async disableTorch(): Promise<void> {\r\n    throw this.createUnavailableException();\r\n  }\r\n\r\n  async toggleTorch(): Promise<void> {\r\n    throw this.createUnavailableException();\r\n  }\r\n\r\n  async isTorchEnabled(): Promise<IsTorchEnabledResult> {\r\n    throw this.createUnavailableException;\r\n  }\r\n\r\n  async isTorchAvailable(): Promise<IsTorchAvailableResult> {\r\n    return { available: false };\r\n  }\r\n\r\n  async setZoomRatio(_options: SetZoomRatioOptions): Promise<void> {\r\n    throw this.createUnavailableException();\r\n  }\r\n\r\n  async getZoomRatio(): Promise<GetZoomRatioResult> {\r\n    throw this.createUnavailableException();\r\n  }\r\n\r\n  async getMinZoomRatio(): Promise<GetMinZoomRatioResult> {\r\n    throw this.createUnavailableException();\r\n  }\r\n\r\n  async getMaxZoomRatio(): Promise<GetMaxZoomRatioResult> {\r\n    throw this.createUnavailableException();\r\n  }\r\n\r\n  async openSettings(): Promise<void> {\r\n    throw this.createUnavailableException();\r\n  }\r\n\r\n  async isGoogleBarcodeScannerModuleAvailable(): Promise<IsGoogleBarcodeScannerModuleAvailableResult> {\r\n    throw this.createUnavailableException();\r\n  }\r\n\r\n  async installGoogleBarcodeScannerModule(): Promise<void> {\r\n    throw this.createUnavailableException();\r\n  }\r\n\r\n  async checkPermissions(): Promise<PermissionStatus> {\r\n    try {\r\n      const result = await navigator.permissions.query({\r\n        name: 'camera' as any,\r\n      });\r\n      return {\r\n        camera: result.state,\r\n      };\r\n    } catch (error) {\r\n      return {\r\n        camera: 'prompt',\r\n      };\r\n    }\r\n  }\r\n\r\n  async requestPermissions(): Promise<PermissionStatus> {\r\n    try {\r\n      const stream = await navigator.mediaDevices.getUserMedia({ video: true });\r\n      stream.getTracks().forEach(track => track.stop());\r\n      return {\r\n        camera: 'granted',\r\n      };\r\n    } catch (error) {\r\n      return {\r\n        camera: 'denied',\r\n      };\r\n    }\r\n  }\r\n\r\n  private createUnavailableException(): CapacitorException {\r\n    return new CapacitorException(\r\n      'This plugin method is not available on this platform.',\r\n      ExceptionCode.Unavailable,\r\n    );\r\n  }\r\n\r\n  private handleScannedBarcodes(barcodes: DetectedBarcode[]): void {\r\n    const result: BarcodesScannedEvent = {\r\n      barcodes: barcodes.map(barcode => ({\r\n        cornerPoints: [\r\n          [barcode.cornerPoints[0].x, barcode.cornerPoints[0].y],\r\n          [barcode.cornerPoints[1].x, barcode.cornerPoints[1].y],\r\n          [barcode.cornerPoints[2].x, barcode.cornerPoints[2].y],\r\n          [barcode.cornerPoints[3].x, barcode.cornerPoints[3].y],\r\n        ],\r\n        displayValue: barcode.rawValue,\r\n        rawValue: barcode.rawValue,\r\n        format: barcode.format.toUpperCase() as BarcodeFormat,\r\n        valueType: BarcodeValueType.Unknown,\r\n      })),\r\n    };\r\n    this.notifyListeners(this.eventBarcodesScanned, result);\r\n  }\r\n}\r\n"]}